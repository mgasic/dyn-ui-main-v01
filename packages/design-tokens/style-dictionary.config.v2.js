const StyleDictionary = require('style-dictionary');

// ============================================
// CUSTOM TRANSFORM: Shorter Token Names
// ============================================
StyleDictionary.registerTransform({
  name: 'name/dyn/short',
  type: 'name',
  transformer: (token) => {
    const path = token.path.slice(1); // Remove 'dyn' prefix
    let name = path.join('-');
    
    // Apply shortcuts for cleaner names
    const shortcuts = {
      'responsive-tabs-color-background': 'responsive-tabs-bg',
      'responsive-tabs-color-text': 'responsive-tabs-text',
      'responsive-tabs-typography-font-size': 'responsive-tabs-font-size',
      'responsive-tabs-typography-font-weight': 'responsive-tabs-font-weight',
      'responsive-tabs-typography-font-family': 'responsive-tabs-font-family',
      'color-background': 'bg',
      'color-text': 'text',
      'typography-font-size': 'font-size',
      'typography-font-weight': 'font-weight',
      'typography-font-family': 'font-family'
    };
    
    // Apply shortcuts
    Object.entries(shortcuts).forEach(([long, short]) => {
      name = name.replace(long, short);
    });
    
    return `--dyn-${name}`;
  }
});

// ============================================
// HELPER: Check if token is a dark theme variant
// ============================================
function isDarkThemeToken(token) {
  // A token is dark theme ONLY if:
  // 1. Path contains 'darkTheme' (component-level dark variants)
  // 2. Path matches pattern like ['dyn', 'component', 'darkTheme', ...]
  
  const pathStr = token.path.join('/');
  
  // Check for explicit darkTheme branch
  if (token.path.includes('darkTheme')) {
    return true;
  }
  
  // NOT dark theme if it's a shade name like:
  // - color/neutral/dark/70 -> This is a shade, not dark theme
  // - color/feedback/negative/dark -> This is a shade, not dark theme
  // Pattern: if 'dark' comes after 'color' and before a number/final value, it's a shade
  
  return false;
}

// ============================================
// CUSTOM FORMAT: CSS with Dark Theme Support
// ============================================
StyleDictionary.registerFormat({
  name: 'css/variables-with-dark',
  formatter: ({ dictionary }) => {
    const tokens = dictionary.allTokens;
    
    // Separate light and dark tokens using precise filter
    const lightTokens = tokens.filter(t => !isDarkThemeToken(t));
    const darkTokens = tokens.filter(t => isDarkThemeToken(t));
    
    let output = '/* ============================================\n';
    output += '   AUTO-GENERATED by Style Dictionary\n';
    output += '   DO NOT EDIT DIRECTLY\n';
    output += '   Source: tokens/**/*.json\n';
    output += '   ============================================ */\n\n';
    
    // Light theme (default) - includes ALL non-darkTheme tokens
    output += ':root {\n';
    lightTokens.forEach(token => {
      if (token.comment) {
        output += `  /* ${token.comment} */\n`;
      }
      output += `  ${token.name}: ${token.value};\n`;
    });
    output += '}\n\n';
    
    // Dark theme (media query) - ONLY darkTheme branch tokens
    if (darkTokens.length > 0) {
      output += '@media (prefers-color-scheme: dark) {\n';
      output += '  :root {\n';
      darkTokens.forEach(token => {
        // Remove 'darkTheme' from path to match light token names
        // Example: dyn-responsive-tabs-dark-theme-bg-inactive
        //       -> dyn-responsive-tabs-bg-inactive
        const lightName = token.name
          .replace('-dark-theme-', '-')
          .replace('-darktheme-', '-');
        
        if (token.comment) {
          output += `    /* ${token.comment} */\n`;
        }
        output += `    ${lightName}: ${token.value};\n`;
      });
      output += '  }\n';
      output += '}\n';
    }
    
    return output;
  }
});

// ============================================
// MAIN CONFIGURATION
// ============================================
module.exports = {
  source: ['tokens/**/*.json'],
  
  platforms: {
    css: {
      transformGroup: 'css',
      transforms: [
        'attribute/cti',
        'name/dyn/short',  // Our custom transform
        'time/seconds',
        'content/icon',
        'size/rem',
        'color/css'
      ],
      buildPath: 'styles/generated/',
      files: [
        {
          // Responsive Tabs Component Tokens
          destination: 'responsive-tabs.css',
          format: 'css/variables-with-dark',
          filter: (token) => {
            return token.filePath.includes('responsive-tabs.json');
          }
        },
        {
          // Table Component Tokens
          destination: 'table.css',
          format: 'css/variables-with-dark',
          filter: (token) => {
            return token.filePath.includes('table.json');
          }
        },
        {
          // Foundation Tokens (all others)
          destination: 'foundations.css',
          format: 'css/variables',
          filter: (token) => {
            return !token.filePath.includes('responsive-tabs.json') && 
                   !token.filePath.includes('table.json');
          }
        }
      ]
    },
    
    // Bonus: JavaScript/TypeScript output
    js: {
      transformGroup: 'js',
      buildPath: 'build/js/',
      files: [
        {
          destination: 'tokens.js',
          format: 'javascript/es6'
        }
      ]
    },
    
    // Bonus: TypeScript types
    ts: {
      transformGroup: 'js',
      buildPath: 'build/ts/',
      files: [
        {
          destination: 'tokens.d.ts',
          format: 'typescript/es6-declarations'
        }
      ]
    }
  }
};
